<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        hr {
            border: none;
            height: 1px;
            background-color: #777;
            margin: 20px 0;
        }
        small {
            font-size: 12px;
            color: #777;
            margin-bottom: 5px;
            display: block;
            font-weight: bold;
        }
        input[type="text"] {
            height: 30px;
            margin-bottom: 10px;
            padding: 5px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 588px;
        }
        input[type="button"] {
            height: 30px;
            margin-bottom: 10px;
            padding: 5px 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: auto;
            background-color: #fff;
            color: #333;
            cursor: pointer;
        }
        input[type="button"]:hover {
            background-color: #f5f5f5;
        }
        .message {
            margin-top: 10px;
            font-weight: bold;
            color: #777;
        }
    </style>
</head>
<body>
    <div class="container">
        <div>
            <small>학생 명단 확인</small>
            <div>
                <input type="button" id="allList" value="명단 확인">
            </div>
        </div>
        <hr>
        <div>
            <small>/user</small>
            <div>
                <input type="text" id="testId" placeholder="학번">
                <input type="button" id="testBtn" value="확인">
            </div>
        </div>
        <hr>
        <div>
            <small>생년월일 업데이트</small>
            <div>
                <input type="text" id="userCode" placeholder="학번">
                <br>
                <input type="text" id="userBirth" placeholder="생년월일">
                <input type="button" id="nmbirthBtn" value="업데이트">
            </div>
        </div>
        <hr>
        <div>
            <small>학생 추가</small>
            <div>
                <input type="text" id="insertName" placeholder="이름">
                <br>
                <input type="text" id="insertAge" placeholder="나이">
                <br>
                <input type="radio" name="gender" value="M"><small style="display:inline-block;margin-right:30px;">남</small>
                <input type="radio" name="gender" value="F"><small style="display:inline-block;">여</small>
                <br>
                <input type="button" id="insertBtn" value="추가">
            </div>
        </div>
        <hr>
        <div>
            <small>학생 삭제</small>
            <div>
                <input type="text" id="delCode" placeholder="학번">
                <br>
                <input type="text" id="delName" placeholder="이름">
                <input type="button" id="delBtn" value="삭제">
            </div>
        </div>
        <hr>
        <div>
            <small>토큰 발행 (1분) <span id="countDownId" style="color:crimson"></span></small>
            <div>
                <input type="button" id="tokenBtn" value="토큰 발행">
                <input type="button" id="tokenCheck" value="토큰 확인">
            </div>
        </div>
        <div class="message" id="message"></div>
    </div>
</body>
</html>
<script>
    var testId = document.getElementById("testId");
    var testBtn = document.getElementById("testBtn");
    var nmbirthBtn = document.getElementById("nmbirthBtn");
    var birthForm = document.getElementById("birthForm");
    var deleteForm = document.getElementById("deleteForm");
    var countdown;

    function getCookie(name) {
        var matches = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + '=([^;]*)'));
        return matches ? decodeURIComponent(matches[1]) : undefined;
    }

    //전체명단 확인(GET)
    $('#allList').click(() => {
        var token = getCookie('Access-Token');
        $.ajax({
            type: 'GET',
            url: "/user",
            headers: {
                "token":token
            },
            success: function (response) {
                var allText = "";
                allText = allText + "<table>"
                allText = allText + "<tr><th>학번</th><th>이름</th></tr>"    
                for(i=0; i<response.length; i++) { //전체 명단 반복
                    allText = allText + "<tr><td>" + response[i].UM_USER_CODE + "</td><td>" + response[i].UM_USER_NM + "</td></th>"
                }
                allText = allText + "</table>"
                document.getElementById("message").innerHTML = allText;
            },
            error: function (xhr, textStatus, error) {
                if(xhr.responseJSON != undefined) { //토큰인증 실패 메세지
                    alert(xhr.responseJSON.errormessage);
                }
            }
        });
    })
    
    //학번으로 데이터 확인(GET)
    testBtn.addEventListener("click", () => {
        var token = getCookie('Access-Token');
        if(testId.value != "") {
            $.ajax({
              	type: 'GET',
                url: "/user/" + testId.value,
                headers: {
                    "token":token
                },
                success: function (response) {
                    var jsonData = JSON.stringify(response, null, 2); // JSON 데이터를 정렬하여 문자열로 변환
                    //alert(jsonData); // alert 창에 JSON 데이터 표시
                    document.getElementById("message").innerText = jsonData;
                },
                error: function (xhr, textStatus, error) {
                    if(xhr.responseJSON != undefined) { //토큰인증 실패 메세지
                        alert(xhr.responseJSON.errormessage);
                    } else if(textStatus == "parsererror") {
                        alert("해당 유저가 없습니다.");
                    } else if(textStatus == "error") {
                        alert("숫자만 입력해주세요");
                    } else {
                        alert("?");
                    }
                }
            });
        } else {
            alert("숫자를 입력하세요.")
        }
    });

    //데이터 일부분 업데이트 (PATCH)
    nmbirthBtn.addEventListener("click", function() {
        var userCode = $("#userCode").val();
        var userBirth = $("#userBirth").val();
        if(userCode != "" && userBirth != "") {
            var token = getCookie('Access-Token');
            $.ajax({
                type: 'PATCH',
                url: "/user/code/" + userCode + "/birth/" + userBirth,
                headers: {
                    "token":token
                },
                success: function (response) {
                    alert("학번: " + userCode + " 학생 생년월일 업데이트 완료")
                },
                error: function (xhr, textStatus, error) {
                    if(xhr.responseJSON != undefined) { //토큰인증 실패 메세지
                        alert(xhr.responseJSON.errormessage);
                    } else if(textStatus == "parsererror") {
                        alert("해당 유저가 없습니다.");
                    } else if(textStatus == "error") {
                        alert("숫자만 입력해주세요");
                    } else {
                        alert("?");
                    }
                }
            });
        } else {
            alert("학번과 생년월일을 작성해주세요");
        }
    });

    //데이터 추가(POST)
    $("#insertBtn").click(function() {
        var insertName = $("#insertName").val();
        var insertAge = $("#insertAge").val();
        var insertGender = $("input[name='gender']:checked").val();
        
        if(insertName != "" && insertAge != "" && insertGender != "") {
            var token = getCookie('Access-Token');
            $.ajax({
                type: 'POST',
                url: "/user/name/" + insertName + "/age/" + insertAge + "/gender/" + insertGender,
                headers: {
                    "token":token
                },
                success: function (response) {
                    alert(insertName + " 추가 완료");
                },
                error: function (xhr, textStatus, error) {
                    if(xhr.responseJSON != undefined) { //토큰인증 실패 메세지
                        alert(xhr.responseJSON.errormessage);
                    } else if(textStatus == "parsererror") {
                        alert("해당 유저가 없습니다.");
                    } else if(textStatus == "error") {
                        alert("숫자만 입력해주세요");
                    } else {
                        alert("?");
                    }
                }
            });
        } else {
            alert("추가에 필요한 데이터를 모두 입력해주세요.");
        }
    });
    
    //데이터 삭제(delete)
    $("#delBtn").click(function() {
        var delCode = $("#delCode").val();
        var delName = $("#delName").val();
        if(delCode != "" && delName != "") {
            var token = getCookie('Access-Token');
            $.ajax({
                type: 'DELETE',
                url: "/user/code/" + delCode + "/name/" + delName,
                headers: {
                    "token":token
                },
                success: function (response) {
                    response.rowsAffected == 1 ? alert(delName + "(" + delCode + ") 삭제 완료") : alert("해당 학생이 명단에 없습니다.");
                },
                error: function (xhr, textStatus, error) {
                    if(xhr.responseJSON != undefined) { //토큰인증 실패 메세지
                        alert(xhr.responseJSON.errormessage);
                    } else if(textStatus == "parsererror") {
                        alert("해당 유저가 없습니다.");
                    } else if(textStatus == "error") {
                        alert("숫자만 입력해주세요");
                    } else {
                        alert("?");
                    }
                }
            });
        } else {
            alert("학번과 이름을 작성해주세요");
        }
    });

    function startCountdown() {
        var seconds = 60;
        if (countdown) {
            clearInterval(countdown);
            countdown = null;
        }

        countdown = setInterval(function() {
            seconds--;
            //$("#countDownId").html(seconds);

            if (seconds <= 0) {
                clearInterval(countdown);
                $("#countDownId").html("토큰 만료");
            }
        }, 1000);
    }

    //토큰 발행 버튼
    $("#tokenBtn").click(function(){
        $.ajax({
            type: 'POST',
            url: `/token`,
            success: function (response) {
                const token = response.token;
                document.cookie = `Access-Token=${token};path=/`;
                alert(response.message)
                startCountdown();
            },
            error: function (xhr, textStatus, error) {}
        });
    });

    //토큰 확인 버튼
    $("#tokenCheck").click(function() {
        var token = getCookie('Access-Token');
        $.ajax({
            type: 'GET',
            url: `/tokencheck`,
            headers: {"token":token},
            success: function (response) {
                alert("정상적인 토큰!");
            },
            error: function (xhr, textStatus, error) {
                alert("만료된 토큰!");
            }
        });
    })

</script>