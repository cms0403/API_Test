<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
</head>
<body>
    <div style="height:1px;border-top: #777 solid 1px;"></div>
    <small>/user</small>
    <div>
        <input type="text" id="testId" style="height:19px">
        <input type="button" id="testBtn" style="height:25px" value="버튼">
    </div>
    <br>
    <div style="height:1px;border-top: #777 solid 1px;"></div>
    <small>생년월일 업데이트</small>
    <div>
        <small>학번: </small><input type="text" id="userCode" style="height:19px"><br>
        <small>생년월일: </small><input type="text" id="userBirth" style="height:19px">
        <input type="button" id="nmbirthBtn" style="height:25px" value="버튼">
    </div>
    <br>
    <div style="height:1px;border-top: #777 solid 1px;"></div>
    <small>학생 삭제</small>
    <div>
        <small>학번: </small><input type="text" id="delCode" style="height:19px"><br>
        <small>이름: </small><input type="text" id="delName" style="height:19px">
        <input type="button" id="delBtn" style="height:25px" value="삭제">
    </div>
    <br>
    <div style="height:1px;border-top: #777 solid 1px;"></div>
    <small>토큰 발행(1분)</small>
    <div>
        <!-- <input type="submit" id="tokenSubmit" value="토큰 발행 SUBMIT"> -->
        <input type="button" id="tokenBtn" value="토큰 발행 버튼">
        <input type="button" id="tokenCheck" value="토큰 확인">
    </div>
</body>
</html>
<script>
    var testId = document.getElementById("testId");
    var testBtn = document.getElementById("testBtn");
    var nmbirthBtn = document.getElementById("nmbirthBtn");
    var birthForm = document.getElementById("birthForm");
    var deleteForm = document.getElementById("deleteForm");
    //학번으로 데이터 확인
    testBtn.addEventListener("click", function() {
        var token = getCookie('Access-Token');
        if(testId.value != "") {
            $.ajax({
                type: 'GET',
                url: "/user/" + testId.value,
                // headers: {"Access-Token":token},
                headers: {
                    "token":token
                },
                success: function (response) {
                    console.log(response);
                },
                error: function (xhr, textStatus, error) {
                    console.log("error: " + error + " xhr: " + xhr + " textStatus: " + textStatus);
                    console.log(xhr);
                    if(xhr.responseJSON.errormessage != "") {
                        alert(xhr.responseJSON.errormessage);
                    }else if(textStatus == "parsererror") {
                        alert("해당 유저가 없습니다.");
                    } else if(textStatus == "error") {
                        alert("숫자만 입력해주세요");
                    } else {
                        alert(xhr.responseJSON.errormessage);
                    }
                }
            });
        } else {
            alert("숫자를 입력하세요.")
        }
    });

    //데이터 업데이트 (PUT)
    nmbirthBtn.addEventListener("click", function() {
        var userCode = $("#userCode").val();
        var userBirth = $("#userBirth").val();
        if(userCode != "" && userBirth != "") {
            var token = getCookie('Access-Token');
            // alert("학번 생년월일 작성 완료");
            // window.location.assign("/user/code/" + userCode.value + "/birth/" + userBirth.value);
            // birthForm.action="/user/put/code/" + userCode + "/birth/" + userBirth + "?method=PUT";
            // birthForm.submit();
            $.ajax({
                type: 'PUT',
                url: "/user/put/code/" + userCode + "/birth/" + userBirth,
                // headers: {"Access-Token":token},
                headers: {
                    "token":token
                },
                success: function (response) {
                    alert(userCode + " 학번 학생 생년월일 업데이트 완료")
                },
                error: function (xhr, textStatus, error) {
                    console.log("error: " + error + " xhr: " + xhr + " textStatus: " + textStatus);
                    console.log(xhr);
                    if(xhr.responseJSON.errormessage != "") {
                        alert(xhr.responseJSON.errormessage);
                    } else if(textStatus == "parsererror") {
                        alert("해당 유저가 없습니다.");
                    } else if(textStatus == "error") {
                        alert("숫자만 입력해주세요");
                    } else {
                        alert(xhr.responseJSON.errormessage);
                    }
                }
            });
        } else {
            alert("학번과 생년월일을 작성해주세요");
        }
    });
    
    //데이터 삭제(delete)
    $("#delBtn").click(function() {
        var delCode = $("#delCode").val();
        var delName = $("#delName").val();
        if(delCode.value != "" && delName != "") {
            var token = getCookie('Access-Token');
            // deleteForm.action="/user/code/" + delCode + "/name/" + delName + "?method=DELETE";
            // deleteForm.submit();
            $.ajax({
                type: 'DELETE',
                url: "/user/code/" + delCode + "/name/" + delName,
                headers: {
                    "token":token
                },
                success: function (response) {
                    alert(delName + "(" + delCode + ") 삭제 완료");
                },
                error: function (xhr, textStatus, error) {
                    console.log("error: " + error + " xhr: " + xhr + " textStatus: " + textStatus);
                    console.log(xhr);
                    if(xhr.responseJSON.errormessage != "") {
                        alert(xhr.responseJSON.errormessage);
                    } else if(textStatus == "parsererror") {
                        alert("해당 유저가 없습니다.");
                    } else if(textStatus == "error") {
                        alert("숫자만 입력해주세요");
                    } else {
                        alert(xhr.responseJSON.errormessage);
                    }
                }
            });
        } else {
            alert("학번과 이름을 작성해주세요");
        }
    });

    function getCookie(name) {
        var matches = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + '=([^;]*)'));
        return matches ? decodeURIComponent(matches[1]) : undefined;
    }

    $("#tokenBtn").click(function(){
        $.ajax({
            type: 'POST',
            url: `/token`,
            success: function (response) {
                const token = response.token;
                document.cookie = `Access-Token=${token};path=/`;
                alert(response.message)
            },
            error: function (xhr, textStatus, error) {}
        });
    });

    $("#tokenCheck").click(function() {
        var token = getCookie('Access-Token');
        $.ajax({
            type: 'GET',
            url: `/tokencheck`,
            // headers: {"Access-Token":token},
            headers: {"token":token},
            success: function (response) {
                alert("정상적인 토큰!");
            },
            error: function (xhr, textStatus, error) {
                alert("만료된 토큰!");
            }
        });
    })

</script>